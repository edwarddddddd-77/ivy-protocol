# âœ… Ivy Protocol - å·²è§£å†³é—®é¢˜æ¸…å•

æœ¬æ–‡æ¡£è®°å½•æ‰€æœ‰å·²è§£å†³çš„å®¡æ ¸é—®é¢˜ï¼Œé¿å…é‡å¤å®¡æ ¸ã€‚

**æœ€åæ›´æ–°ï¼š** 2026-01-08

---

## ğŸŸ¢ å·²æ­£ç¡®å®ç°çš„åŠŸèƒ½

### 1. **æ¨èå¥–åŠ±æ€»é‡æ§åˆ¶ï¼ˆIvyCore.solï¼‰**
- **çŠ¶æ€ï¼š** âœ… å·²æ­£ç¡®å®ç°
- **ä½ç½®ï¼š** IvyCore.sol ç¬¬ 641-672 è¡Œ
- **é€»è¾‘ï¼š**
  ```solidity
  // æå‰è®¡ç®—æ€»éœ€æ±‚ï¼ˆç”¨æˆ· + 17.5% æ¨èï¼‰
  uint256 totalRewardsNeeded = pending + estimatedReferralRewards;

  // å¦‚æœè¶…è¿‡å‰©ä½™é¢åº¦ï¼ŒæŒ‰æ¯”ä¾‹ç¼©å‡
  if (totalMinted + totalRewardsNeeded > MINING_CAP) {
      pending = (availableSpace * BASIS_POINTS) / (BASIS_POINTS + TOTAL_REFERRAL_RATE);
  }
  ```
- **æ•ˆæœï¼š**
  - ç”¨æˆ·å¾—åˆ° 100% åŸºç¡€å¥–åŠ±
  - æ¨èé¢å¤–å¾—åˆ° 17.5% å¥–åŠ±
  - æ‰€æœ‰é“¸é€ æ€»å’Œ â‰¤ 70M

---

### 2. **testMode ä¸å¯é€†æœºåˆ¶ï¼ˆIvyCore.solï¼‰**
- **çŠ¶æ€ï¼š** âœ… å·²å®ç°
- **æäº¤ï¼š** commit 489875f
- **ä½ç½®ï¼š** IvyCore.sol
- **é€»è¾‘ï¼š**
  ```solidity
  bool public testModeDisabledPermanently;

  function setTestMode(bool _testMode) external onlyOwner {
      if (!_testMode) {
          // åˆ‡æ¢åˆ°ä¸»ç½‘æ¨¡å¼ï¼ˆä¸å¯é€†ï¼‰
          require(address(oracle) != address(0), "Must set oracle before disabling test mode");
          testModeDisabledPermanently = true;
          testMode = false;
      } else {
          // å°è¯•é‡æ–°å¯ç”¨æµ‹è¯•æ¨¡å¼
          require(!testModeDisabledPermanently, "Test mode permanently disabled");
          testMode = true;
      }
  }
  ```
- **æ•ˆæœï¼š**
  - æµ‹è¯•ç½‘æœŸé—´ï¼šOwner å¯æ§åˆ¶ä»·æ ¼æ›´æ–°
  - ä¸»ç½‘å¯åŠ¨åï¼šæ°¸ä¹…ç¦ç”¨ testModeï¼Œå¿…é¡»é€šè¿‡ Oracle

---

### 3. **Golden Pivot é€»è¾‘ï¼ˆæ­£ç¡®çš„ï¼‰**
- **çŠ¶æ€ï¼š** âœ… è®¾è®¡æ­£ç¡®ï¼Œä¸æ˜¯ Bug
- **ä½ç½®ï¼š** IvyToken.sol, IvyCore.sol, Photosynthesis.sol
- **é€»è¾‘ï¼š**
  ```solidity
  if (totalSupply() <= GOLDEN_PIVOT) {
      // ä¾›åº”é‡ â‰¤ 21Mï¼šåœæ­¢ç‡ƒçƒ§ï¼Œåˆ‡æ¢åˆ°åˆ†çº¢æ¨¡å¼
  } else {
      // ä¾›åº”é‡ > 21Mï¼šç»§ç»­ç‡ƒçƒ§
  }
  ```
- **è®¾è®¡æ„å›¾ï¼š**
  - æ€»é‡ä» 30M å¢é•¿åˆ° 100M
  - é€šè¿‡ç‡ƒçƒ§é™è‡³ 21M
  - è¾¾åˆ° 21M ååœæ­¢ç‡ƒçƒ§ï¼ˆç›®æ ‡è¾¾æˆï¼‰

---

### 4. **ä»£å¸æ€»é‡åˆ†é…ï¼ˆæ­£ç¡®çš„ï¼‰**
- **çŠ¶æ€ï¼š** âœ… è®¾è®¡æ­£ç¡®ï¼Œä¸å­˜åœ¨æº¢å‡º
- **åˆ†é…æ–¹æ¡ˆï¼š**
  ```
  æ€»é‡ï¼š100M IVY
  â”œâ”€ 70% (70M)ï¼šæŒ–çŸ¿
  â””â”€ 30% (30M)ï¼šé¢„é“¸
      â”œâ”€ 15% (15M)ï¼šLP å‚¨å¤‡ï¼ˆåŒ…å«åœ¨é¢„é“¸ä¸­ï¼‰
      â”œâ”€ 10% (10M)ï¼šDAO
      â””â”€ 5% (5M)ï¼šè¿è¥

  éªŒè¯ï¼š70M + 30M = 100M âœ…
  ```
- **è¯´æ˜ï¼š** LP å‚¨å¤‡æ˜¯ä» 30M é¢„é“¸ä¸­åˆ’åˆ†çš„ï¼Œä¸æ˜¯é¢å¤–çš„ 15M

---

### 5. **æ¸è¿›å¼ LP ç­–ç•¥å®ç°ï¼ˆLPManager.solï¼‰**
- **çŠ¶æ€ï¼š** âœ… æ¶æ„è®¾è®¡æ­£ç¡®
- **æäº¤ï¼š** commit 91e1f75
- **ä½ç½®ï¼š** contracts/LPManager.solï¼ˆæ–°å¢ï¼‰
- **åŠŸèƒ½ï¼š**
  - 4 é˜¶æ®µæ¸è¿›å¼å‚¨å¤‡æ¶ˆè€—
  - é˜¶æ®µ 1: 80% å‚¨å¤‡ + 20% å¸‚åœºä¹°å…¥
  - é˜¶æ®µ 2: 50% å‚¨å¤‡ + 50% å¸‚åœºä¹°å…¥
  - é˜¶æ®µ 3: 20% å‚¨å¤‡ + 80% å¸‚åœºä¹°å…¥
  - é˜¶æ®µ 4: 0% å‚¨å¤‡ + 100% å¸‚åœºä¹°å…¥
- **æ³¨æ„ï¼š** è™½ç„¶æ¶æ„æ­£ç¡®ï¼Œä½† LP é…å¯¹é€»è¾‘æœ‰ Bugï¼ˆè§å¾…ä¿®å¤é—®é¢˜ #4ï¼‰

---

### 6. **IvyToken.sol åŒé‡é“¸é€ æƒé™æœºåˆ¶**
- **çŠ¶æ€ï¼š** âœ… å·²å®ç°
- **ä½ç½®ï¼š** IvyToken.sol
- **é€»è¾‘ï¼š**
  ```solidity
  // æŒ–çŸ¿é“¸é€ æƒé™
  address public minter;  // IvyCore
  function mint(address to, uint256 amount) external {
      require(msg.sender == minter, "Not minter");
      _mint(to, amount);
  }

  // LP å‚¨å¤‡é“¸é€ æƒé™
  address public lpMinter;  // LPManager
  function mintForLP(address to, uint256 amount) external {
      require(msg.sender == lpMinter, "Not LP minter");
      _mint(to, amount);
  }
  ```
- **æ•ˆæœï¼š** æŒ–çŸ¿å’Œ LP å‚¨å¤‡åˆ†å¼€ç®¡ç†

---

### 7. **IvyBond èµ„é‡‘åˆ†é…ï¼ˆ40/50/10ï¼‰**
- **çŠ¶æ€ï¼š** âœ… å·²æ­£ç¡®å®ç°
- **ä½ç½®ï¼š** IvyBond.sol deposit() å‡½æ•°
- **é€»è¾‘ï¼š**
  ```solidity
  uint256 toRWA = (amount * 4000) / 10000;        // 40%
  uint256 toLiquidity = (amount * 5000) / 10000;  // 50%
  uint256 toDonation = (amount * 1000) / 10000;   // 10%
  ```
- **æ•ˆæœï¼š**
  - 40% å¯èµå›ï¼ˆ180å¤©åï¼‰
  - 50% è¿›å…¥ LP æ± ï¼ˆç®—åŠ›ï¼‰
  - 10% æèµ ï¼ˆä¸å¯èµå›ï¼‰

---

### 8. **æ¨èç³»ç»Ÿå¤šå±‚çº§å¥–åŠ±**
- **çŠ¶æ€ï¼š** âœ… å·²æ­£ç¡®å®ç°
- **ä½ç½®ï¼š** IvyCore.sol _distributeReferralRewards()
- **é€»è¾‘ï¼š**
  - L1 ç›´æ¨ï¼š10%
  - L2 é—´æ¨ï¼š5%
  - Team Bonusï¼š2%ï¼ˆBreakaway ç®—æ³•ï¼‰
  - Peer Bonusï¼š0.5%
  - æ€»è®¡ï¼š17.5%
- **ç‰¹æ€§ï¼š**
  - æœ€å¤§æ·±åº¦ 20 å±‚ï¼ˆé˜²æ­¢ gas è€—å°½ï¼‰
  - Breakawayï¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ª GenesisNode æŒæœ‰è€…å³åœæ­¢

---

### 9. **åŠ¨æ€å‡åŠæœºåˆ¶**
- **çŠ¶æ€ï¼š** âœ… å·²å®ç°
- **ä½ç½®ï¼š** IvyCore.sol _checkHalving()
- **é€»è¾‘ï¼š**
  ```solidity
  // æ¯é“¸é€  7M IVYï¼ŒemissionFactor *= 0.95
  while (totalMinted >= (halvingCount + 1) * HALVING_THRESHOLD) {
      emissionFactor = (emissionFactor * 95) / 100;
      halvingCount++;
  }
  ```

---

### 10. **PID ç®—æ³•å®ç°**
- **çŠ¶æ€ï¼š** âœ… å…¬å¼æ­£ç¡®
- **ä½ç½®ï¼š** IvyCore.sol _calculatePIDAlpha()
- **å…¬å¼ï¼š** Î± = (P/MA30)Â²
- **é™åˆ¶ï¼š**
  - ä¸Šé™ï¼š1.5x
  - ä¸‹é™ï¼š0.1x

---

### 11. **ç†”æ–­å™¨æœºåˆ¶**
- **çŠ¶æ€ï¼š** âœ… é€»è¾‘æ­£ç¡®
- **ä½ç½®ï¼š** IvyCore.sol checkCircuitBreaker()
- **é˜ˆå€¼ï¼š**
  - Level 1: -10% â†’ 0.5x
  - Level 2: -15% â†’ 0.2x
  - Level 3: -25% â†’ 0.05x
- **å†·å´æ—¶é—´ï¼š** 4h / 12h / 24h

---

### 12. **vesting çº¿æ€§é‡Šæ”¾**
- **çŠ¶æ€ï¼š** âœ… å·²å®ç°
- **ä½ç½®ï¼š** IvyCore.sol claimVested()
- **é€»è¾‘ï¼š**
  ```solidity
  // 30 å¤©çº¿æ€§é‡Šæ”¾
  uint256 vestedAmount = (info.totalVested * timeElapsed) / VESTING_PERIOD;
  uint256 claimable = vestedAmount - info.totalClaimed;
  ```

---

### 13. **instantCashOut 50% æƒ©ç½š**
- **çŠ¶æ€ï¼š** âœ… å·²å®ç°
- **ä½ç½®ï¼š** IvyCore.sol instantCashOut()
- **é€»è¾‘ï¼š**
  ```solidity
  uint256 penalty = (remaining * 5000) / 10000;  // 50%
  uint256 received = remaining - penalty;
  ```
- **æ³¨æ„ï¼š** æƒ©ç½šå…¨éƒ¨é”€æ¯ï¼ˆä¸ç®¡æ˜¯å¦è¾¾åˆ° Golden Pivotï¼‰

---

### 14. **GenesisNode ä¾›åº”ä¸Šé™**
- **çŠ¶æ€ï¼š** âœ… å·²å®ç°
- **ä½ç½®ï¼š** GenesisNode.sol
- **é€»è¾‘ï¼š**
  ```solidity
  uint256 public constant MAX_SUPPLY = 1386;
  require(_nextTokenId < MAX_SUPPLY, "Max supply reached");
  ```

---

### 15. **GenesisNode è‡ªåŠ©æ¨è +10%, å›¢é˜Ÿå…‰ç¯ +2%**
- **çŠ¶æ€ï¼š** âœ… å·²å®ç°
- **ä½ç½®ï¼š** GenesisNode.sol getTotalBoost()
- **é€»è¾‘ï¼š**
  ```solidity
  uint256 selfBoost = balanceOf(user) > 0 ? 1000 : 0;   // 10%
  uint256 teamAura = balanceOf(upline) > 0 ? 200 : 0;    // 2%
  return selfBoost + teamAura;
  ```

---

## âœ… å·²ä¿®å¤ Bug (2026-01-08 ä¿®å¤)

### Bug #1: compoundVested() ç¼ºå°‘é“¸é€ å’Œé”€æ¯
- **çŠ¶æ€ï¼š** âœ… å·²ä¿®å¤
- **ä½ç½®ï¼š** IvyCore.sol:1015-1041
- **é—®é¢˜ï¼š** æ¸…ç©º pendingVested ä½†æ²¡æœ‰é“¸é€  IVY ä¹Ÿæ²¡æœ‰é”€æ¯
- **å½±å“ï¼š** ç”¨æˆ·èµ„é‡‘æ°¸ä¹…ä¸¢å¤±ï¼Œé€šç¼©æœºåˆ¶å¤±æ•ˆ
- **ä¿®å¤ï¼š**
  - æ·»åŠ ç¬¬ 1021-1022 è¡Œï¼šé“¸é€  IVYï¼ˆvIVY â†’ çœŸå® IVYï¼Œå ç”¨æŒ–çŸ¿é¢åº¦ï¼‰
  - æ·»åŠ ç¬¬ 1038 è¡Œï¼šé”€æ¯åˆ° 0xdeadï¼ˆé€šç¼©æœºåˆ¶ï¼‰
  - å®Œæ•´æµç¨‹ï¼švIVY â†’ mint IVY â†’ burn IVY â†’ è·å¾— 110% NFT ç®—åŠ›
- **åŒæ—¶ä¿®å¤ï¼š** claimVested() ä»çº¿æ€§é‡Šæ”¾æ”¹ä¸ºä¸¥æ ¼ 30 å¤©ç­‰å¾…æœŸï¼ˆç¬¬ 716-720 è¡Œï¼‰

### Bug #2: DividendPool.syncUser() ä¸¢å¤±åˆ†çº¢
- **çŠ¶æ€ï¼š** âœ… å·²ä¿®å¤
- **ä½ç½®ï¼š** DividendPool.sol:132-155
- **é—®é¢˜ï¼š** æ›´æ–° bondPower æ—¶ç›´æ¥è¦†ç›– debtï¼Œæ²¡æœ‰ä¿å­˜ pending dividends
- **å½±å“ï¼š** ç”¨æˆ·æ¯æ¬¡å¢åŠ ç®—åŠ›æ—¶ä¸¢å¤±å·²ç´¯ç§¯åˆ†çº¢
- **ä¿®å¤ï¼š**
  - ç¬¬ 136-143 è¡Œï¼šç”¨æ—§ç®—åŠ›è®¡ç®— pending
  - ç¬¬ 146 è¡Œï¼šæ›´æ–°å¿«ç…§ä¸ºæ–°ç®—åŠ›
  - ç¬¬ 151-152 è¡Œï¼šè°ƒæ•´ debt ä¿ç•™ pendingï¼ˆå…¬å¼ï¼š`newDebt = accumulated - pending`ï¼‰
  - ç¡®ä¿ç”¨æˆ·åœ¨ç®—åŠ›å˜åŒ–æ—¶ä¸ä¼šä¸¢å¤±å·²ç´¯ç§¯çš„åˆ†çº¢

### Bug #3: Photosynthesis MA30 æ°¸ä¸æ›´æ–°
- **çŠ¶æ€ï¼š** âœ… å·²ä¿®å¤
- **ä½ç½®ï¼š** Photosynthesis.sol:59-61, 248-266
- **é—®é¢˜ï¼š** åªæ›´æ–° currentPriceï¼Œma30Price ä¿æŒåˆå§‹å€¼ $1.0
- **å½±å“ï¼š** ç‰›ç†Šå¸‚åˆ¤æ–­æ°¸ä¹…é”™è¯¯ï¼ˆæ€»æ˜¯ä¸ $1.0 æ¯”è¾ƒï¼‰
- **ä¿®å¤ï¼š**
  - ç¬¬ 61 è¡Œï¼šOracle æ¥å£æ·»åŠ  `getMA30Price()` å‡½æ•°
  - ç¬¬ 258-265 è¡Œï¼šprocessRwaYield() åŒæ—¶è·å–å’Œæ›´æ–° currentPrice å’Œ ma30Price
  - ç¡®ä¿ç‰›ç†Šå¸‚åˆ¤æ–­ä½¿ç”¨çœŸå®çš„ 30 å¤©ç§»åŠ¨å¹³å‡ä»·æ ¼

### Bug #4: LPManager LP é…å¯¹é€»è¾‘é”™è¯¯
- **çŠ¶æ€ï¼š** âœ… å·²ä¿®å¤
- **ä½ç½®ï¼š** LPManager.sol:189-243
- **é—®é¢˜ï¼š**
  1. å‡è®¾ 1:1 IVY:USDT ä»·æ ¼ï¼ˆç¬¬ 262 è¡Œï¼‰
  2. èŠ±è´¹ USDT è´­ä¹° IVY åï¼Œå‰©ä½™ USDT ä¸è¶³æ·»åŠ  LPï¼ˆæ—§ç¬¬ 210-222 è¡Œï¼‰
- **å½±å“ï¼š** LP æ·»åŠ å¤±è´¥æˆ–æ¯”ä¾‹é”™è¯¯
- **ä¿®å¤ï¼š**
  - ç¬¬ 206 è¡Œï¼šè®¡ç®— marketBuyRatioï¼ˆä¸ reserveRatio ç›¸åï¼‰
  - ç¬¬ 210 è¡Œï¼šæ­£ç¡®å…¬å¼ `balancedAmount = totalUSDT / (1 + marketBuyRatio)`
  - ç¬¬ 213-218 è¡Œï¼šæŒ‰ balancedAmount åˆ†é… IVY å’Œ USDT
  - ç¤ºä¾‹ï¼ˆ5000 USDT, 80% å‚¨å¤‡ï¼‰ï¼š
    - balancedAmount = 5000 / 1.2 = 4166.67
    - é“¸é€  3333.33 IVYï¼ˆ80%ï¼‰
    - è´­ä¹° 833.33 IVYï¼ˆèŠ±è´¹ 833.33 USDTï¼‰
    - æ·»åŠ  LPï¼š4166.67 IVY + 4166.67 USDT
    - æ€»è®¡ï¼š833.33 + 4166.67 = 5000 USDT âœ“

---

## ğŸ“ å®¡æ ¸ç¬”è®°

**é‡è¦æé†’ï¼š**
- Golden Pivot é€»è¾‘æ˜¯**æ­£ç¡®çš„**ï¼Œä¸è¦å†æŠŠå®ƒå½“ä½œ Bug
- ä»£å¸æ€»é‡åˆ†é…æ˜¯**æ­£ç¡®çš„**ï¼Œ100M = 70M æŒ–çŸ¿ + 30M é¢„é“¸ï¼ˆLP å‚¨å¤‡åŒ…å«åœ¨é¢„é“¸ä¸­ï¼‰
- æ¨èå¥–åŠ±æ€»é‡æ§åˆ¶**å·²å®ç°**ï¼Œä¸ä¼šè¶…è¿‡ 70M æŒ–çŸ¿ä¸Šé™
- testMode ä¸å¯é€†æœºåˆ¶**å·²å®ç°**ï¼Œä¸»ç½‘å¯åŠ¨åæ— æ³•å›é€€

**ä¸‹æ¬¡å®¡æ ¸æ—¶ï¼š**
1. å…ˆè¯»å–æœ¬æ–‡æ¡£ï¼Œè·³è¿‡å·²è§£å†³çš„é—®é¢˜
2. æŸ¥çœ‹"å·²ä¿®å¤ Bug"éƒ¨åˆ†ï¼Œç¡®è®¤ä¿®å¤å†…å®¹
3. æ–°å‘ç°çš„ Bug æ·»åŠ åˆ°æœ¬æ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.0 (æ‰€æœ‰å·²çŸ¥ Bug å·²ä¿®å¤)
**åˆ›å»ºæ—¥æœŸï¼š** 2026-01-08
**æœ€åæ›´æ–°ï¼š** 2026-01-08 (ä¿®å¤ 4 ä¸ª Bug)
**ç»´æŠ¤è€…ï¼š** Claude Sonnet 4.5
