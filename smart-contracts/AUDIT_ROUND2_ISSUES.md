# 🔍 Ivy Protocol - 第二轮审核问题清单

**审核日期：** 2026-01-08
**审核范围：** 全部核心合约（IvyCore, IvyToken, IvyBond, LPManager, DividendPool, Photosynthesis）
**审核方式：** 4 个 AI Agents 并行深度审核 + 人工复核

---

## 📋 问题分类说明

- **🔴 P0 - 立即修复**：上线前必须修复，否则有资金损失或严重用户体验问题
- **🟡 P1 - 尽快修复**：建议在上线前修复，可能影响协议安全性或用户体验
- **🟢 P2 - 成熟期优化**：不影响核心功能，可在主网运行一段时间后优化

---

## 🔴 P0 - 立即修复（上线前必须，共 5 个）

### ❌ 问题 #1：IvyCore - getUserMiningStats() 逻辑不一致
- **文件**：`IvyCore.sol:903-912`
- **严重程度**：🔴 HIGH
- **状态**：❌ 待修复
- **问题描述**：
  - `claimVested()` 要求严格等待 30 天（第 719 行）
  - 但 `getUserMiningStats()` 使用线性释放公式计算可领取金额（第 909 行）
  - 导致前端显示"可领取 50%"，但实际调用会失败
- **影响**：用户体验极差，大量投诉
- **修复方案**：修改 `getUserMiningStats()` 匹配实际的 30 天锁定逻辑
- **涉及前端**：✅ 是（前端需要更新 UI 显示逻辑）
- **修复优先级**：P0

---

### ❌ 问题 #2：LPManager - 无滑点保护（MEV 攻击风险）
- **文件**：`LPManager.sol:284, 307-308`
- **严重程度**：🔴 CRITICAL
- **状态**：❌ 待修复
- **问题描述**：
  - `swapExactTokensForTokens()` 的 `amountOutMin = 0`
  - `addLiquidity()` 的 `amountAMin/BMin = 0`
  - MEV 机器人可以抢先交易套利
- **影响**：用户资金被套利者窃取，每次可能损失 5-10%
- **修复方案**：添加 5% 滑点保护
- **涉及前端**：❌ 否
- **修复优先级**：P0

---

### ❌ 问题 #3：IvyBond - 赎回依赖外部钱包（资金安全风险）
- **文件**：`IvyBond.sol:339, 476`
- **严重程度**：🔴 CRITICAL
- **状态**：❌ 待修复
- **问题描述**：
  - 40% RWA 资金发送到外部 `rwaWallet`
  - 赎回时从 `rwaWallet` 拉取资金（`safeTransferFrom`）
  - 如果 `rwaWallet` 资金被挪用或撤销 approve，用户无法赎回
- **影响**：用户资金永久损失
- **修复方案**：合约自己持有 40% 赎回资金，不发送到外部钱包
- **涉及前端**：⚠️ 可能（需要确认 RWA 资金的显示逻辑）
- **修复优先级**：P0

---

### ❌ 问题 #4：IvyBond - 舍入误差导致资金锁定
- **文件**：`IvyBond.sol:334-336`
- **严重程度**：🔴 HIGH
- **状态**：❌ 待修复
- **问题描述**：
  - 40% + 50% + 10% 三个整数除法
  - 总和可能小于原始金额（舍入误差）
  - 剩余资金永久锁在合约
- **影响**：累积后可能锁定大量资金
- **修复方案**：让捐赠部分吸收所有舍入误差（`toDonation = amount - toRWA - toLiquidity`）
- **涉及前端**：❌ 否
- **修复优先级**：P0

---

### ❌ 问题 #5：IvyBond - addCompoundPower 访问控制缺陷
- **文件**：`IvyBond.sol:698-714`
- **严重程度**：🔴 HIGH
- **状态**：❌ 待修复
- **问题描述**：
  - 没有检查 `ivyCore` 是否已设置
  - 没有限制单次添加的算力上限
  - `setIvyCore()` 可以被 owner 多次修改
- **影响**：如果 `ivyCore` 被恶意设置，可能操纵算力系统
- **修复方案**：
  1. 检查 `ivyCore != address(0)`
  2. 限制单次算力上限（如 100 万 IVY）
  3. 限制 `ivyCore` 只能设置一次
- **涉及前端**：❌ 否
- **修复优先级**：P0

---

## 🟡 P1 - 尽快修复（建议上线前完成，共 8 个）

### ❌ 问题 #6：IvyToken - 双重 minter 无隔离上限
- **文件**：`IvyToken.sol:242-257`
- **严重程度**：🟡 MEDIUM
- **状态**：❌ 待修复
- **问题描述**：`minter` (IvyCore) 和 `lpMinter` (LPManager) 都可以 mint 到 100M，没有 70M/15M 分配隔离
- **影响**：如果 LPManager 被攻破，可以铸造超额代币
- **修复方案**：添加 `minterUsed` 和 `lpMinterUsed` 追踪，分别限制 70M 和 15M
- **涉及前端**：❌ 否
- **修复优先级**：P1

---

### ❌ 问题 #7：IvyCore - compoundVested() 缺少 MINING_CAP 检查
- **文件**：`IvyCore.sol:1027-1028`
- **严重程度**：🟡 MEDIUM
- **状态**：❌ 待修复
- **问题描述**：直接 mint，没有检查是否超过 70M cap
- **影响**：可能导致 totalMinted 超过 70M
- **修复方案**：添加 cap 检查和缩减逻辑
- **涉及前端**：❌ 否
- **修复优先级**：P1

---

### ❌ 问题 #8：LPManager - approve 未重置可能导致 DoS
- **文件**：`LPManager.sol:295, 319-320`
- **严重程度**：🟡 MEDIUM
- **状态**：❌ 待修复
- **问题描述**：`safeApprove` 不允许从非零改为非零，可能导致交易失败
- **影响**：某些情况下 LP 添加失败
- **修复方案**：使用 `safeIncreaseAllowance` 或先 approve(0)
- **涉及前端**：❌ 否
- **修复优先级**：P1

---

### ❌ 问题 #9：IvyBond - approve 残留问题
- **文件**：`IvyBond.sol:343-344`
- **严重程度**：🟡 MEDIUM
- **状态**：❌ 待修复
- **问题描述**：与问题 #8 相同
- **修复方案**：与问题 #8 相同
- **涉及前端**：❌ 否
- **修复优先级**：P1

---

### ❌ 问题 #10：LPManager - balancedAmount 精度损失
- **文件**：`LPManager.sol:213-214`
- **严重程度**：🟡 MEDIUM
- **状态**：❌ 待修复
- **问题描述**：`ivyFromReserve + ivyFromMarket` 可能不等于 `balancedAmount`（整数除法截断）
- **影响**：少量 IVY 差异（< 1 wei）
- **修复方案**：`ivyFromMarket = balancedAmount - ivyFromReserve`
- **涉及前端**：❌ 否
- **修复优先级**：P1

---

### ❌ 问题 #11：IvyBond - totalPrincipal 状态不同步
- **文件**：`IvyBond.sol:473`
- **严重程度**：🟡 MEDIUM
- **状态**：❌ 待修复
- **问题描述**：赎回时 `bond.principal = 0`，但 `totalPrincipal` 没有减少
- **影响**：全局统计不准确
- **修复方案**：`totalPrincipal -= redeemAmount`
- **涉及前端**：❌ 否
- **修复优先级**：P1

---

### ❌ 问题 #12：IvyToken - 小额转账免税（精度损失）
- **文件**：`IvyToken.sol:299-301`
- **严重程度**：🟡 MEDIUM
- **状态**：❌ 待修复
- **问题描述**：转账 < 1000 tokens 时，税收可能为 0（整数除法截断）
- **影响**：小额转账逃税
- **修复方案**：添加最小税额或四舍五入
- **涉及前端**：❌ 否
- **修复优先级**：P1

---

### ❌ 问题 #13：IvyCore - PID 算法缺少价格合理性检查
- **文件**：`IvyCore.sol:402-418`
- **严重程度**：🟡 MEDIUM
- **状态**：❌ 待修复
- **问题描述**：如果 Oracle 返回极端价格（如 $1,000,000），可能导致所有 `updatePool()` 失败
- **影响**：Oracle 故障时协议 DoS
- **修复方案**：添加价格合理性检查（如 $0.01 - $1,000）
- **涉及前端**：❌ 否
- **修复优先级**：P1

---

## 🟢 P2 - 成熟期优化（主网运行后改进，共 6 个）

### ⏳ 问题 #14：IvyCore - syncUser() 可被任何人调用
- **文件**：`IvyCore.sol:561-601`
- **严重程度**：🟢 LOW
- **状态**：⏳ 成熟期优化
- **问题描述**：任何人都可以调用 `syncUser()`，导致 Gas 浪费
- **影响**：攻击者承担 gas，无资金损失
- **修复方案**：移除 `external` 修饰符，仅内部使用
- **涉及前端**：⚠️ 可能（需确认前端是否调用 syncUser）
- **修复优先级**：P2

---

### ⏳ 问题 #15：IvyBond - 缺少暂停机制
- **文件**：`IvyBond.sol`
- **严重程度**：🟢 LOW
- **状态**：⏳ 成熟期优化
- **问题描述**：发现漏洞时无法紧急暂停
- **修复方案**：添加 `Pausable` 功能
- **涉及前端**：❌ 否
- **修复优先级**：P2

---

### ⏳ 问题 #16：LPManager - LP tokens 永久锁定
- **文件**：`LPManager.sol:330`
- **严重程度**：🟢 LOW
- **状态**：⏳ 成熟期优化
- **问题描述**：LP tokens 归 LPManager 合约，无法管理
- **修复方案**：添加管理员函数提取到多签钱包
- **涉及前端**：❌ 否
- **修复优先级**：P2

---

### ⏳ 问题 #17：IvyToken - Batch 操作无上限
- **文件**：`IvyToken.sol:176-182`
- **严重程度**：🟢 LOW
- **状态**：⏳ 成熟期优化
- **问题描述**：`batchSetExcludedFromTax()` 无循环上限，可能 gas 耗尽
- **修复方案**：限制 100 个地址
- **涉及前端**：❌ 否
- **修复优先级**：P2

---

### ⏳ 问题 #18：IvyCore - circuitBreaker 只能升级不能降级
- **文件**：`IvyCore.sol:446`
- **严重程度**：🟢 LOW
- **状态**：⏳ 成熟期优化
- **问题描述**：价格恢复时熔断器不会自动降级，依赖 owner 手动重置
- **修复方案**：添加自动降级逻辑
- **涉及前端**：❌ 否
- **修复优先级**：P2

---

### ⏳ 问题 #19：LPManager - 价格硬编码 $1.0
- **文件**：`LPManager.sol:283-287`
- **严重程度**：🟢 LOW
- **状态**：⏳ 成熟期优化
- **问题描述**：`_getIvyAmountForLP()` 假设 IVY = $1.0，币价偏离时 LP 比例失衡
- **修复方案**：集成 Oracle 或 Uniswap TWAP
- **涉及前端**：❌ 否
- **修复优先级**：P2

---

## 📊 统计汇总

| 优先级 | 数量 | 状态 | 是否涉及前端 |
|--------|------|------|-------------|
| 🔴 P0 - 立即修复 | 5 个 | ❌ 待修复 | 1 个涉及前端 (#1) |
| 🟡 P1 - 尽快修复 | 8 个 | ❌ 待修复 | 0 个涉及前端 |
| 🟢 P2 - 成熟期优化 | 6 个 | ⏳ 延后处理 | 1 个可能涉及 (#14) |
| **总计** | **19 个** | - | **2 个涉及前端** |

---

## 🎯 修复计划

### 阶段 1：立即修复（本次 commit）
- [ ] 问题 #1：IvyCore - getUserMiningStats() 逻辑修正
- [ ] 问题 #2：LPManager - 添加滑点保护
- [ ] 问题 #3：IvyBond - 修改赎回资金管理
- [ ] 问题 #4：IvyBond - 修复舍入误差
- [ ] 问题 #5：IvyBond - 加强访问控制
- [ ] 问题 #6：IvyToken - 添加分配上限追踪
- [ ] 问题 #7：IvyCore - compoundVested cap 检查
- [ ] 问题 #8-9：修复 approve 问题
- [ ] 问题 #10-13：修复其他中危问题

### 阶段 2：前端配合修改
- [ ] 问题 #1 前端：更新 vesting 显示逻辑（30 天锁定，非线性）
- [ ] 问题 #3 前端：确认 RWA 资金显示（合约持有 vs 外部钱包）

### 阶段 3：成熟期优化（主网运行后）
- [ ] 问题 #14-19：低危优化（按需处理）

---

## ✅ 已解决问题（第一轮修复）

参见 [RESOLVED_ISSUES.md](./RESOLVED_ISSUES.md)

1. ✅ Bug #1: compoundVested() 缺少铸造和销毁
2. ✅ Bug #2: DividendPool.syncUser() 丢失分红
3. ✅ Bug #3: Photosynthesis MA30 不更新
4. ✅ Bug #4: LPManager LP 配对逻辑错误

---

## 📝 备注

- **Golden Pivot 逻辑**：已确认正确，不是 Bug（供应量从 100M 燃烧至 21M）
- **推荐奖励总量控制**：已确认正确实现（17.5% 已纳入 70M cap）
- **testMode 不可逆**：已确认正确实现
- **代币总量分配**：已确认正确（100M = 70M 挖矿 + 30M 预铸）

---

**文档版本：** v1.0
**创建日期：** 2026-01-08
**维护者：** Claude Sonnet 4.5
