# Ivy Protocol V2.5 核心算法与风控参数定义书 阅读笔记

## 文档概述
- 版本: Final V1.0
- 适用对象: 智能合约工程师 / 后端开发
- 目的: 明确 PID 控制器、熔断机制及产出衰减的硬性代码参数

---

## 1. PID 算力系数 (The PID Coefficient)

**结论: 锁定 k = 2.0**

### 参数依据
根据《PID 动态释放算法 365 天仿真报告》，k=2.0 在"疯牛"、"崩盘"和"死亡螺旋"三个极端剧本中表现最为平衡。

| 参数 | k=1.5 | k=2.0 ✅ | k=2.5 |
|------|-------|---------|-------|
| 波动率 (CV) | 最小 | 平衡 | 最高 |
| 市场反应 | 迟钝 | 及时 | 敏感 |
| 牛市表现 | 无法有效刺激 | 最优 | 过度反应 |
| 熊市表现 | 反应延迟 | 最优 | 二次恐慌 |
| 综合评分 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

### 代码实现公式
```
α = (P_now / MA_30) ^ 2.0
```
- **α**: PID 释放系数 (无量纲)
- **P_now**: 当前价格 (TWAP 24小时加权平均)
- **MA_30**: 30 天移动平均价格
- **k**: 敏感度系数 = 2.0 (硬锁定)

### 上下限约束
- **上限 (Cap)**: α_max = 1.5 (最大增产 50%)
- **下限 (Floor)**: α_min = 0.1 (最低保留 10% 产出)

---

## 2. 动态半衰期机制 (Dynamic Halving Mechanism)

**结论: 必须添加**

### 原因
引入 PID 和节点加成后，单纯依靠 PID 调节可能导致在长期大牛市中矿池过早枯竭。需要引入"剩余储量挂钩"的半衰期机制，确保挖矿周期强制维持在 4-6 年。

### 参数设定

| 参数 | 值 | 说明 |
|------|-----|------|
| 初始基础日产量 | 30,000 IVY | 不含 PID 调节 |
| 触发阈值 | 每挖出 700 万枚 | 相对于 70M 总量的 10% |
| 衰减幅度 | 基础日产量 × 0.95 | 每次衰减 5% |
| 总衰减次数 | 10 次 | 完全衰减至 0 |
| 预计周期 | 4-6 年 | 根据市场情况 |

### 衰减阶段表

| 阶段 | 触发条件 | 基础日产量 | 累计衰减 |
|------|---------|----------|--------|
| 第 1 阶段 | 初始 | 30,000 IVY | 0% |
| 第 2 阶段 | 挖出 700 万枚 | 28,500 IVY | 5% |
| 第 3 阶段 | 挖出 1,400 万枚 | 27,075 IVY | 9.75% |
| 第 4 阶段 | 挖出 2,100 万枚 | 25,721 IVY | 14.26% |
| 第 5 阶段 | 挖出 2,800 万枚 | 24,435 IVY | 18.55% |
| ... | ... | ... | ... |
| 第 10 阶段 | 挖出 6,300 万枚 | 18,906 IVY | 36.98% |

---

## 3. 熔断机制确切参数 (Circuit Breaker Parameters)

**结论: 采用三级阶梯熔断 (Tiered Circuit Breaker)**

### 参数表

| 熔断等级 | 触发条件 (1小时价格跌幅) | PID 强制系数 (α) | 冷却时间 | 解除条件 |
|---------|---------------------|----------------|---------|---------|
| 一级 (黄色) | 10% < 跌幅 < 15% | 0.5 (减半) | 4 小时 | 冷却结束后，若价格回升至触发价上方，自动解除 |
| 二级 (橙色) | 15% ≤ 跌幅 < 25% | 0.2 (剩2成) | 12 小时 | 冷却结束后，需连续 2 个 1H K线为阳线 |
| 三级 (红色) | 跌幅 ≥ 25% | 0.05 (急停) | 24 小时 | 24小时内不可解除，防止连环踩踏 |

### 数据源
使用 Chainlink 预言机获取价格，合约计算 1 小时价格变化率:
```
Price Change Rate = (Current Price - Price 1h Ago) / Price 1h Ago
```

---

## 4. 每日总产出校验公式 (Master Minting Formula)

### 公式
```
Daily Total Mint = Base × (0.95)^n × α_PID × (1 + 10% + 17.5%)
                   \_半衰期基础_/   \_PID调节_/  \__权益放大__/
```

### 参数说明

| 参数 | 说明 | 值 |
|------|------|-----|
| Base | 初始基础日产量 | 30,000 IVY |
| n | 已触发半衰期的次数 | 0-10 |
| (0.95)^n | 半衰期衰减系数 | 1.0 - 0.366 |
| α_PID | 当前 PID 系数 (受熔断机制覆盖) | 0.1 - 1.5 |
| 10%_Self | 创世节点自身算力加成平均值 | 10% |
| 17.5%_Marketing | 市场推广最大支出 | 10%(L1) + 5%(L2) + 2%(L3~∞) + 0.5%(管理津贴) |

### 计算示例

**场景 1: 正常情况 (第 1 阶段，牛市)**
```
Base = 30,000 IVY
n = 0, (0.95)^0 = 1.0
α_PID = 1.2 (牛市)
权益放大 = 1.275

Daily Total Mint = 30,000 × 1.0 × 1.2 × 1.275 = 45,900 IVY/天
```

**场景 2: 熊市 + 半衰期衰减**
```
Base = 30,000 IVY
n = 3, (0.95)^3 = 0.857
α_PID = 0.5 (熊市，二级熔断)
权益放大 = 1.275

Daily Total Mint = 30,000 × 0.857 × 0.5 × 1.275 = 16,392 IVY/天
```

**场景 3: 极端崩盘 + 红色熔断**
```
Base = 30,000 IVY
n = 5, (0.95)^5 = 0.774
α_PID = 0.05 (极端崩盘，三级熔断)
权益放大 = 1.275

Daily Total Mint = 30,000 × 0.774 × 0.05 × 1.275 = 1,481 IVY/天
```

---

## 5. 合约部署检查清单 (Deployment Checklist)

### 必须验证的参数
- [ ] PID 系数 k = 2.0 (硬锁定)
- [ ] PID 上限 α_max = 1.5
- [ ] PID 下限 α_min = 0.1
- [ ] 基础日产量 = 30,000 IVY
- [ ] 半衰期触发阈值 = 700 万 IVY
- [ ] 半衰期衰减幅度 = 5%
- [ ] 一级熔断阈值 = -10% ~ -15%，α = 0.5
- [ ] 二级熔断阈值 = -15% ~ -25%，α = 0.2
- [ ] 三级熔断阈值 = ≥ -25%，α = 0.05
- [ ] 一级冷却时间 = 4 小时
- [ ] 二级冷却时间 = 12 小时
- [ ] 三级冷却时间 = 24 小时 (硬锁定)

### 测试场景
1. **正常情况**: 验证每日产出 = 30,000 × 1.0 × 1.0 × 1.275 ≈ 38,250 IVY
2. **牛市**: 验证 PID 系数正确上升至 1.5
3. **熊市**: 验证 PID 系数正确下降至 0.1
4. **一级熔断**: 验证产出降低至 50%
5. **二级熔断**: 验证产出降低至 20%
6. **三级熔断**: 验证产出降低至 5%
7. **半衰期触发**: 验证基础日产量正确衰减 5%

---

## 6. 给智能合约工程师的最终建议

### 核心要点
1. **PID 系数定死为 2.0** - 基于 365 天仿真报告的三个极端场景验证，不可调整
2. **半衰期加上了** - 解决"什么时候挖完"的后顾之忧，确保 4-6 年的挖矿周期
3. **熔断分级了** - 提供三个不同的风险应对等级，不会因为一次误操作就死锁

### 实现优先级
1. **优先级 1 (必须)**: PID 系数计算 (k=2.0)、上下限约束、基础日产量计算
2. **优先级 2 (必须)**: 半衰期机制、三级熔断机制、每日总产出校验公式
3. **优先级 3 (强烈建议)**: 监控仪表板、参数验证函数、紧急暂停机制

### 代码审计建议
- 使用定点数学库 (如 ABDKMath64x64) 避免浮点精度问题
- 所有除法操作必须检查溢出/下溢
- 所有幂运算必须使用安全的数学库
- 价格预言机必须使用 Chainlink 官方接口
- 所有时间戳操作必须使用 block.timestamp

---

## 附录: 常见问题 (FAQ)

**Q1: 为什么选择 k=2.0 而不是 k=1.5 或 k=2.5?**
A: 根据 365 天仿真报告，k=2.0 在三个极端场景 (疯牛、崩盘、死亡螺旋) 中表现最平衡。k=1.5 过于迟钝，k=2.5 波动过大。

**Q2: 半衰期机制会不会导致产出过快耗尽?**
A: 不会。半衰期是基于"已挖出的数量"触发的，不是基于时间。即使在牛市中，也需要挖出 700 万枚才能触发一次衰减。预计 4-6 年内完成所有 10 次衰减。

**Q3: 三级熔断机制会不会过于敏感?**
A: 不会。一级熔断 (-10% ~ -15%) 只是降低 PID 系数至 50%，不是完全停产。只有三级熔断 (≥ -25%) 才会进入 24 小时硬锁定。

**Q4: 如果价格在熔断期间反弹，是否会自动解除?**
A: 是的。一级和二级熔断有自动解除条件。三级熔断必须等待 24 小时硬锁定期。

**Q5: 权益放大系数 1.275 是如何计算的?**
A: 假设平均所有用户都持有创世 NFT (+10%)，加上市场推广返佣 (+17.5%)，总放大 = (1 + 0.1 + 0.175) = 1.275。

---

**文档完成日期:** 2025 年 12 月 30 日
**适用版本:** Ivy Protocol V2.5 Final
**状态:** ✅ 已锁定，可用于合约开发
